<<<<<<< HEAD
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Panel - Student Record Manager</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css" />
</head>

<body>
  <header>
    <div>
      <h1>ğŸ“ Admin Panel</h1>
    </div>
    <div id="userInfo">
      <div style="margin-bottom: 0; margin-right: 20px; display: inline-block;">
        <span id="username"></span>
        <span id="adminBadge">ADMIN</span>
      </div>
      <div style="display: inline-block;">
        <button onclick="window.location.href='/'">ğŸ  Dashboard</button>
        <button onclick="logout()">ğŸšª Logout</button>
      </div>
    </div>
  </header>

  <main>
    <div style="text-align: center; margin: 30px 0 20px;">
      <h2>ğŸ‘¥ All Users</h2>
      <p style="color: var(--secondary); margin-top: 10px;">Manage all registered users</p>
    </div>

    <table id="usersTable">
      <thead>
        <tr>
          <th>Username</th>
          <th>Email</th>
          <th>Students</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="usersTableBody"></tbody>
    </table>
  </main>

  <footer>
    Â© 2025 Student Record Manager | Admin Panel
  </footer>


  <script>
    const API = "http://localhost:8000";

    window.addEventListener('DOMContentLoaded', () => {
      checkAuth();
      loadUserInfo();
    });

    function getAuthHeaders() {
      const token = localStorage.getItem('token');
      return {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      };
    }

    async function checkAuth() {
      const token = localStorage.getItem('token');
      if (!token) {
        window.location.href = '/login.html';
        return false;
      }

      try {
        const res = await fetch(`${API}/api/user/`, {
          headers: getAuthHeaders()
        });

        if (res.status === 401) {
          localStorage.removeItem('token');
          localStorage.removeItem('user');
          window.location.href = '/login.html';
          return false;
        }

        const data = await res.json();
        if (!data.user || !data.user.is_admin) {
          alert('Admin access required');
          window.location.href = '/';
          return false;
        }

        return true;
      } catch (error) {
        return true;
      }
    }

    function loadUserInfo() {
      const userStr = localStorage.getItem('user');
      if (userStr) {
        const user = JSON.parse(userStr);
        const usernameEl = document.getElementById('username');
        if (usernameEl) {
          usernameEl.textContent = `ğŸ‘‹ Welcome, ${user.username}!`;
          usernameEl.style.color = '#58a6ff';
        }
      }
    }

    function logout() {
      if (confirm('Are you sure you want to logout?')) {
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        window.location.href = '/login.html';
      }
    }

    function showMessage(message, type = 'success') {
      const existing = document.querySelector('.message');
      if (existing) {
        existing.remove();
      }

      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${type}`;
      messageDiv.textContent = message;
      document.body.appendChild(messageDiv);

      setTimeout(() => {
        messageDiv.style.animation = 'slideIn 0.3s ease reverse';
        setTimeout(() => messageDiv.remove(), 300);
      }, 3000);
    }

    async function getUsers() {
      const isAuth = await checkAuth();
      if (!isAuth) return;

      const tableBody = document.getElementById('usersTableBody');
      tableBody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px; color: #8b949e;">Loading...</td></tr>';

      try {
        const res = await fetch(`${API}/api/admin/users/`, {
          headers: getAuthHeaders()
        });

        if (res.status === 401 || res.status === 403) {
          if (res.status === 403) {
            alert('Admin access required');
            window.location.href = '/';
          } else {
            logout();
          }
          return;
        }

        const data = await res.json();
        tableBody.innerHTML = '';

        if (data.error) {
          showMessage(data.error, 'error');
          tableBody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px; color: #ff79c6;">Error loading users</td></tr>';
          return;
        }

        if (data.length === 0) {
          tableBody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px; color: #8b949e;">No users found</td></tr>';
          return;
        }

        data.forEach(user => {
          const row = document.createElement('tr');
          row.style.borderBottom = '1px solid rgba(0, 255, 255, 0.1)';
          row.style.color = '#c9d1d9';
          row.innerHTML = `
            <td style="padding: 15px;">${user.username}</td>
            <td style="padding: 15px;">${user.email}</td>
            <td style="padding: 15px; font-weight: bold; color: #fff;">${user.student_count || 0}</td>
            <td style="padding: 15px;">
              <span style="padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; ${user.is_admin ? 'background: rgba(255, 0, 255, 0.2); color: #ff79c6; border: 1px solid rgba(255, 0, 255, 0.3);' : 'background: rgba(0, 255, 255, 0.2); color: #58a6ff; border: 1px solid rgba(0, 255, 255, 0.3);'}">
                ${user.is_admin ? 'ADMIN' : 'USER'}
              </span>
            </td>
            <td style="padding: 15px;">
              <button onclick="toggleAdmin('${user._id}', ${user.is_admin})" style="padding: 6px 12px; margin: 0 5px; border: none; border-radius: 5px; cursor: pointer; font-size: 12px; font-weight: 600; background: rgba(0, 255, 255, 0.2); color: #58a6ff; border: 1px solid rgba(0, 255, 255, 0.3);">
                ${user.is_admin ? 'Remove Admin' : 'Make Admin'}
              </button>
              <button onclick="deleteUser('${user._id}')" style="padding: 6px 12px; margin: 0 5px; border: none; border-radius: 5px; cursor: pointer; font-size: 12px; font-weight: 600; background: rgba(255, 0, 255, 0.2); color: #ff79c6; border: 1px solid rgba(255, 0, 255, 0.3);">
                Delete
              </button>
            </td>
          `;
          tableBody.appendChild(row);
        });
      } catch (error) {
        console.error('Error fetching users:', error);
        showMessage('Error loading users', 'error');
        tableBody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px; color: #ff79c6;">Error loading users. Please refresh the page.</td></tr>';
      }
    }

    async function toggleAdmin(userId, currentStatus) {
      const isAuth = await checkAuth();
      if (!isAuth) return;

      if (!confirm(`Are you sure you want to ${currentStatus ? 'remove admin status from' : 'make'} this user?`)) {
        return;
      }

      try {
        const res = await fetch(`${API}/api/admin/users/${userId}/`, {
          method: 'PUT',
          headers: getAuthHeaders(),
          body: JSON.stringify({ is_admin: !currentStatus })
        });

        if (res.status === 401 || res.status === 403) {
          if (res.status === 403) {
            showMessage('Admin access required', 'error');
          } else {
            logout();
          }
          return;
        }

        const data = await res.json();
        if (data.error) {
          showMessage(data.error, 'error');
          return;
        }

        showMessage(data.message || 'User status updated!', 'success');
        getUsers();
      } catch (error) {
        console.error('Error updating user:', error);
        showMessage('Error updating user', 'error');
      }
    }

    async function deleteUser(userId) {
      const isAuth = await checkAuth();
      if (!isAuth) return;

      if (!confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
        return;
      }

      try {
        const res = await fetch(`${API}/api/admin/users/${userId}/delete/`, {
          method: 'DELETE',
          headers: getAuthHeaders()
        });

        if (res.status === 401 || res.status === 403) {
          if (res.status === 403) {
            showMessage('Admin access required', 'error');
          } else {
            logout();
          }
          return;
        }

        const data = await res.json();
        if (data.error) {
          showMessage(data.error, 'error');
          return;
        }

        showMessage(data.message || 'User deleted!', 'success');
        getUsers();
      } catch (error) {
        console.error('Error deleting user:', error);
        showMessage('Error deleting user', 'error');
      }
    }

    // Load users on page load
    (async () => {
      const isAuth = await checkAuth();
      if (isAuth) {
        getUsers();
      }
    })();
  </script>
</body>

=======
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Panel - Student Record Manager</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css" />
</head>

<body>
  <header>
    <div>
      <h1>ğŸ“ Admin Panel</h1>
    </div>
    <div id="userInfo">
      <div style="margin-bottom: 0; margin-right: 20px; display: inline-block;">
        <span id="username"></span>
        <span id="adminBadge">ADMIN</span>
      </div>
      <div style="display: inline-block;">
        <button onclick="window.location.href='/'">ğŸ  Dashboard</button>
        <button onclick="logout()">ğŸšª Logout</button>
      </div>
    </div>
  </header>

  <main>
    <div style="text-align: center; margin: 30px 0 20px;">
      <h2>ğŸ‘¥ All Users</h2>
      <p style="color: var(--secondary); margin-top: 10px;">Manage all registered users</p>
    </div>

    <table id="usersTable">
      <thead>
        <tr>
          <th>Username</th>
          <th>Email</th>
          <th>Students</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="usersTableBody"></tbody>
    </table>
  </main>

  <footer>
    Â© 2025 Student Record Manager | Admin Panel
  </footer>


  <script>
    const API = "http://localhost:8000";

    window.addEventListener('DOMContentLoaded', () => {
      checkAuth();
      loadUserInfo();
    });

    function getAuthHeaders() {
      const token = localStorage.getItem('token');
      return {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      };
    }

    async function checkAuth() {
      const token = localStorage.getItem('token');
      if (!token) {
        window.location.href = '/login.html';
        return false;
      }

      try {
        const res = await fetch(`${API}/api/user/`, {
          headers: getAuthHeaders()
        });

        if (res.status === 401) {
          localStorage.removeItem('token');
          localStorage.removeItem('user');
          window.location.href = '/login.html';
          return false;
        }

        const data = await res.json();
        if (!data.user || !data.user.is_admin) {
          alert('Admin access required');
          window.location.href = '/';
          return false;
        }

        return true;
      } catch (error) {
        return true;
      }
    }

    function loadUserInfo() {
      const userStr = localStorage.getItem('user');
      if (userStr) {
        const user = JSON.parse(userStr);
        const usernameEl = document.getElementById('username');
        if (usernameEl) {
          usernameEl.textContent = `ğŸ‘‹ Welcome, ${user.username}!`;
          usernameEl.style.color = '#58a6ff';
        }
      }
    }

    function logout() {
      if (confirm('Are you sure you want to logout?')) {
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        window.location.href = '/login.html';
      }
    }

    function showMessage(message, type = 'success') {
      const existing = document.querySelector('.message');
      if (existing) {
        existing.remove();
      }

      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${type}`;
      messageDiv.textContent = message;
      document.body.appendChild(messageDiv);

      setTimeout(() => {
        messageDiv.style.animation = 'slideIn 0.3s ease reverse';
        setTimeout(() => messageDiv.remove(), 300);
      }, 3000);
    }

    async function getUsers() {
      const isAuth = await checkAuth();
      if (!isAuth) return;

      const tableBody = document.getElementById('usersTableBody');
      tableBody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px; color: #8b949e;">Loading...</td></tr>';

      try {
        const res = await fetch(`${API}/api/admin/users/`, {
          headers: getAuthHeaders()
        });

        if (res.status === 401 || res.status === 403) {
          if (res.status === 403) {
            alert('Admin access required');
            window.location.href = '/';
          } else {
            logout();
          }
          return;
        }

        const data = await res.json();
        tableBody.innerHTML = '';

        if (data.error) {
          showMessage(data.error, 'error');
          tableBody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px; color: #ff79c6;">Error loading users</td></tr>';
          return;
        }

        if (data.length === 0) {
          tableBody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px; color: #8b949e;">No users found</td></tr>';
          return;
        }

        data.forEach(user => {
          const row = document.createElement('tr');
          row.style.borderBottom = '1px solid rgba(0, 255, 255, 0.1)';
          row.style.color = '#c9d1d9';
          row.innerHTML = `
            <td style="padding: 15px;">${user.username}</td>
            <td style="padding: 15px;">${user.email}</td>
            <td style="padding: 15px; font-weight: bold; color: #fff;">${user.student_count || 0}</td>
            <td style="padding: 15px;">
              <span style="padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; ${user.is_admin ? 'background: rgba(255, 0, 255, 0.2); color: #ff79c6; border: 1px solid rgba(255, 0, 255, 0.3);' : 'background: rgba(0, 255, 255, 0.2); color: #58a6ff; border: 1px solid rgba(0, 255, 255, 0.3);'}">
                ${user.is_admin ? 'ADMIN' : 'USER'}
              </span>
            </td>
            <td style="padding: 15px;">
              <button onclick="toggleAdmin('${user._id}', ${user.is_admin})" style="padding: 6px 12px; margin: 0 5px; border: none; border-radius: 5px; cursor: pointer; font-size: 12px; font-weight: 600; background: rgba(0, 255, 255, 0.2); color: #58a6ff; border: 1px solid rgba(0, 255, 255, 0.3);">
                ${user.is_admin ? 'Remove Admin' : 'Make Admin'}
              </button>
              <button onclick="deleteUser('${user._id}')" style="padding: 6px 12px; margin: 0 5px; border: none; border-radius: 5px; cursor: pointer; font-size: 12px; font-weight: 600; background: rgba(255, 0, 255, 0.2); color: #ff79c6; border: 1px solid rgba(255, 0, 255, 0.3);">
                Delete
              </button>
            </td>
          `;
          tableBody.appendChild(row);
        });
      } catch (error) {
        console.error('Error fetching users:', error);
        showMessage('Error loading users', 'error');
        tableBody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px; color: #ff79c6;">Error loading users. Please refresh the page.</td></tr>';
      }
    }

    async function toggleAdmin(userId, currentStatus) {
      const isAuth = await checkAuth();
      if (!isAuth) return;

      if (!confirm(`Are you sure you want to ${currentStatus ? 'remove admin status from' : 'make'} this user?`)) {
        return;
      }

      try {
        const res = await fetch(`${API}/api/admin/users/${userId}/`, {
          method: 'PUT',
          headers: getAuthHeaders(),
          body: JSON.stringify({ is_admin: !currentStatus })
        });

        if (res.status === 401 || res.status === 403) {
          if (res.status === 403) {
            showMessage('Admin access required', 'error');
          } else {
            logout();
          }
          return;
        }

        const data = await res.json();
        if (data.error) {
          showMessage(data.error, 'error');
          return;
        }

        showMessage(data.message || 'User status updated!', 'success');
        getUsers();
      } catch (error) {
        console.error('Error updating user:', error);
        showMessage('Error updating user', 'error');
      }
    }

    async function deleteUser(userId) {
      const isAuth = await checkAuth();
      if (!isAuth) return;

      if (!confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
        return;
      }

      try {
        const res = await fetch(`${API}/api/admin/users/${userId}/delete/`, {
          method: 'DELETE',
          headers: getAuthHeaders()
        });

        if (res.status === 401 || res.status === 403) {
          if (res.status === 403) {
            showMessage('Admin access required', 'error');
          } else {
            logout();
          }
          return;
        }

        const data = await res.json();
        if (data.error) {
          showMessage(data.error, 'error');
          return;
        }

        showMessage(data.message || 'User deleted!', 'success');
        getUsers();
      } catch (error) {
        console.error('Error deleting user:', error);
        showMessage('Error deleting user', 'error');
      }
    }

    // Load users on page load
    (async () => {
      const isAuth = await checkAuth();
      if (isAuth) {
        getUsers();
      }
    })();
  </script>
</body>

>>>>>>> 41616403719a7a8cd313d224c939fa3000bb6427
</html>